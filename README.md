# docker-cloud

nextcloud docker

*old version with gui* [here](https://github.com/devel0/docker-cloud/tree/85370dc6a08002e2ba1011599a4bb974b09bfd1d)

## prerequisites

- `/scripts/constants` with `ip_cloud_srv`, `ip_cloud_psql_srv`, `ip_cloud_sync_srv` ip addresses of cloud containers
- `/security/cloud_psql/postgres` clear text password of postgres db user ( must 600 mode )

## configure client sync

| file | variable | description |
|---|---|---|
| [VARIABLES](VARIABLES) | `CLOUD_ADMIN_PWDFILE` | path to cloud `admin` user pass file |
| " | `CLOUD_SERVER` | cloud server hostname |
| " | `CLOUD_LOCAL_FOLDER` | nas root or other host folder to sync with remote folder | 
| " | `CLOUD_REMOTE_FOLDER` | cloud remote folder or empty |

example

```
CLOUD_SERVER=cloud.searchathing.com
CLOUD_ADMIN_PWDFILE=/security/cloud/admin
CLOUD_LOCAL_FOLDER=/nas/cloud
CLOUD_REMOTE_FOLDER=
```

### excluded sync folder

- To avoid syncing some local folders ( relativ to CLOUD_NAS_ROOT ) insert these in [sync-exclude.lst](cloud_sync_cmdline/imgdata/sync-exclude.lst)
- To avoid start sync after a local change in some folder edit list in [cloud_sync_cmdline/imgdata/wait_changes](wait_changes) ( eg. /nas/SoftCollect where /nas is the path in container local filesystem )

## how it works

- [wait_changes](cloud_sync_cmdline/imgdata/wait_changes) wait for changes on local filesystem using inotify ( may need to increase [max_user_watches](https://github.com/devel0/knowledge/blob/697060acd63ce9172f0e49bc8a9bfea296b50a14/doc/tune-inotify.md) ) and notify changes to a /log file
- [wait_changes2](cloud_sync_cmdline/imgdata/wait_changes2) wait for changes on /log file ( then changes coming from local ) or coming from remote by comparing /root/res_etag.xml ( generated by [update_etag](cloud_sync_cmdline/imgdata/update_etag) )

Timing variables in wait_changes2:
- `remotePollIntervalSec` ( default=30 ) : time to compare etag for remote changes detect
- `forceSyncAfterLocalSyncSec` ( default=300 ) : when local changes happens a sync almost immediately ( 1sec ) starts and when finished etag of remote will also update but during this sync may a remote changes occurs in some minor cases so that to avoid lost of syncing between local remote in these cases a sync forced after 5 minutes. A better approach would to retrieve etag list from result of [nextcloudcmd](https://github.com/nextcloud/desktop) but actually log contains crowded information about sync scan recursive.
- `forceSyncIntervalSec` ( default=7200 1 hr ) : a sync to avoid any issue between local, remote changes detection.

## install

- install cloud postgres

```
cd cloud_psql
./run.sh
cd ..
```

- install cloud

```
cd cloud
./run.sh
cd ..
```

- install cloud_sync_cmdline

```
cd cloud_sync_cmdline
./build.sh
./run.sh
```
